name: Test Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
    
    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin
    
    - name: Check if external dependencies exist
      id: check_deps
      run: |
        if [ -d "../zerobus-sdk-rs/sdk" ] && [ -f "../zerobus-sdk-rs/sdk/Cargo.toml" ]; then
          echo "zerobus_sdk_exists=true" >> $GITHUB_OUTPUT
        else
          echo "zerobus_sdk_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Run tests with coverage
      if: steps.check_deps.outputs.zerobus_sdk_exists == 'true'
      run: |
        cargo tarpaulin --features python --out Xml --output-dir coverage/
        cargo tarpaulin --features python --out Html --output-dir coverage/
        cargo tarpaulin --features python --out Lcov --output-dir coverage/
    
    - name: Run tests with coverage (without external SDK)
      if: steps.check_deps.outputs.zerobus_sdk_exists == 'false'
      continue-on-error: true
      run: |
        echo "External dependencies not available, skipping coverage for SDK-dependent code"
        # Run coverage only on modules that don't require external dependencies
        cargo tarpaulin --features python --exclude-files '**/zerobus.rs' --exclude-files '**/wrapper/mod.rs' --out Xml --output-dir coverage/ || echo "Coverage completed with exclusions"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Check coverage threshold
      if: steps.check_deps.outputs.zerobus_sdk_exists == 'true'
      continue-on-error: true
      run: |
        # Extract coverage percentage from tarpaulin output
        if [ -f "coverage/cobertura.xml" ]; then
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1)
          THRESHOLD=90.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi
          echo "Coverage $COVERAGE% meets threshold $THRESHOLD%"
        else
          echo "Coverage file not found, skipping threshold check"
        fi

